---
alwaysApply: true
---

# AGENT.md - å›½å¯Œ Excel å·¥å…·å¼€å‘æŒ‡å—

> **é¢å‘ AI ä»£ç†çš„é¡¹ç›®è§„èŒƒæ–‡æ¡£**
> æœ¬æ–‡æ¡£ä¸º AI ç¼–ç¨‹åŠ©æ‰‹æä¾›é¡¹ç›®æ¶æ„ã€æŠ€æœ¯æ ˆå’Œå¼€å‘æœ€ä½³å®è·µçš„å…¨é¢æŒ‡å—ã€‚

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆæ¶æ„](#æŠ€æœ¯æ ˆæ¶æ„)
3. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
4. [æ ¸å¿ƒé…ç½®æ–‡ä»¶](#æ ¸å¿ƒé…ç½®æ–‡ä»¶)
5. [å¼€å‘å·¥ä½œæµ](#å¼€å‘å·¥ä½œæµ)
6. [ä»£ç è§„èŒƒä¸æœ€ä½³å®è·µ](#ä»£ç è§„èŒƒä¸æœ€ä½³å®è·µ)
7. [Electron ç‰¹å®šæŒ‡å—](#electron-ç‰¹å®šæŒ‡å—)
8. [å‰ç«¯å¼€å‘æŒ‡å—](#å‰ç«¯å¼€å‘æŒ‡å—)
9. [åç«¯å¤„ç†æŒ‡å—](#åç«¯å¤„ç†æŒ‡å—)
10. [æ„å»ºä¸åˆ†å‘](#æ„å»ºä¸åˆ†å‘)
11. [å¸¸è§ä»»åŠ¡å‚è€ƒ](#å¸¸è§ä»»åŠ¡å‚è€ƒ)
12. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## é¡¹ç›®æ¦‚è¿°

### æ ¸å¿ƒå®šä½
**å›½å¯Œ Excel å·¥å…·** æ˜¯ä¸€ä¸ªåŸºäº Electron çš„æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œä¸“æ³¨äº **æ¨¡æ¿é©±åŠ¨çš„æŠ¥è¡¨ç”Ÿæˆ**ã€‚

### æ ¸å¿ƒå“²å­¦
- **æ¨¡æ¿å³é…ç½®**ï¼šç³»ç»Ÿä»¥ Excel æ¨¡æ¿ä¸ºå”¯ä¸€äº‹å®æ¥æº
- **è®¾è®¡ä¸è¿è¡Œåˆ†ç¦»**ï¼šåˆ›å»º"æŠ¥è¡¨å¥‘çº¦"ï¼ˆé…ç½®ï¼‰ä¸æ‰§è¡ŒæŠ¥è¡¨ç”Ÿæˆå®Œå…¨è§£è€¦
- **é›¶ç¼–ç ä½¿ç”¨**ï¼šç”¨æˆ·é€šè¿‡ GUI é…ç½®æ•°æ®ç»‘å®šï¼Œæ— éœ€ç¼–å†™ä»£ç 

### ä¸šåŠ¡æµç¨‹
1. **è®¾è®¡é˜¶æ®µ**ï¼šä¸Šä¼ æ¨¡æ¿ â†’ è§£æ Carbone æ ‡è®° â†’ é…ç½®æ•°æ®ç»‘å®š â†’ ä¿å­˜"æŠ¥è¡¨å¥‘çº¦"
2. **è¿è¡Œé˜¶æ®µ**ï¼šé€‰æ‹©å¥‘çº¦ â†’ è¾“å…¥å‚æ•° â†’ ä¸Šä¼ æ•°æ® â†’ ç”ŸæˆæŠ¥è¡¨

è¯¦è§ï¼š`doc/doc.md`

---

## æŠ€æœ¯æ ˆæ¶æ„

### è¿è¡Œç¯å¢ƒ
```
Electron 38.x
â”œâ”€â”€ Chromium (æ¸²æŸ“è¿›ç¨‹ - å‰ç«¯)
â”œâ”€â”€ Node.js (ä¸»è¿›ç¨‹ - åç«¯)
â””â”€â”€ V8 JavaScript Engine
```

### å‰ç«¯æŠ€æœ¯æ ˆ
| æŠ€æœ¯           | ç‰ˆæœ¬  | ç”¨é€”                          |
| -------------- | ----- | ----------------------------- |
| **Vue**        | 3.5   | æ¸è¿›å¼ UI æ¡†æ¶ï¼ˆç»„åˆå¼ APIï¼‰  |
| **Vite**       | 7.x   | æ„å»ºå·¥å…· + å¼€å‘æœåŠ¡å™¨         |
| **TypeScript** | 5.9   | ç±»å‹å®‰å…¨                      |
| **Tailwind CSS** | 4.x   | å®ç”¨ä¼˜å…ˆçš„ CSS æ¡†æ¶           |
| **Pinia**      | æœ€æ–°  | Vue å®˜æ–¹çŠ¶æ€ç®¡ç†åº“            |
| **Vue Router** | æœ€æ–°  | å•é¡µåº”ç”¨è·¯ç”±                  |

### åç«¯æŠ€æœ¯æ ˆ
| æŠ€æœ¯       | ç”¨é€”                                      |
| ---------- | ----------------------------------------- |
| **Node.js** | Electron ä¸»è¿›ç¨‹è¿è¡Œç¯å¢ƒ                   |
| **execa**   | æ›´å¥½çš„å­è¿›ç¨‹æ‰§è¡Œåº“ï¼ˆæ›¿ä»£ child_processï¼‰  |
| **carbone** | æŠ¥è¡¨æ¨¡æ¿å¼•æ“ï¼ˆæ”¯æŒ `{{d.}}` å’Œ `{{v.}}` æ ‡è®°ï¼‰ |
| **exceljs** | Excel æ–‡ä»¶è¯»å†™å’Œæ“ä½œ                      |

### æ„å»ºå·¥å…·
```
electron-vite 4.x
â”œâ”€â”€ ä¸»è¿›ç¨‹æ„å»º (Rollup + esbuild)
â”œâ”€â”€ é¢„åŠ è½½è„šæœ¬æ„å»º (Rollup)
â””â”€â”€ æ¸²æŸ“è¿›ç¨‹æ„å»º (Vite)
```

---

## é¡¹ç›®ç»“æ„

### æ ‡å‡† electron-vite é¡¹ç›®ç»“æ„
```
guofu-excel-tool/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/              # ä¸»è¿›ç¨‹ï¼ˆNode.js ç¯å¢ƒï¼‰
â”‚   â”‚   â””â”€â”€ index.ts       # å…¥å£ï¼šåˆ›å»ºçª—å£ã€IPC é€šä¿¡ã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
â”‚   â”œâ”€â”€ preload/           # é¢„åŠ è½½è„šæœ¬ï¼ˆæ¡¥æ¥ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹ï¼‰
â”‚   â”‚   â”œâ”€â”€ index.ts       # contextBridge æš´éœ²å®‰å…¨ API
â”‚   â”‚   â””â”€â”€ index.d.ts     # TypeScript ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ renderer/          # æ¸²æŸ“è¿›ç¨‹ï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰
â”‚       â”œâ”€â”€ index.html     # ä¸» HTML å…¥å£
â”‚       â””â”€â”€ src/
â”‚           â”œâ”€â”€ main.ts    # Vue åº”ç”¨å…¥å£
â”‚           â”œâ”€â”€ App.vue    # æ ¹ç»„ä»¶
â”‚           â”œâ”€â”€ assets/    # é™æ€èµ„æºï¼ˆCSSã€å›¾ç‰‡ï¼‰
â”‚           â”œâ”€â”€ components/ # Vue ç»„ä»¶
â”‚           â”œâ”€â”€ stores/    # Pinia çŠ¶æ€ç®¡ç†ï¼ˆå»ºè®®æ·»åŠ ï¼‰
â”‚           â”œâ”€â”€ views/     # é¡µé¢çº§ç»„ä»¶ï¼ˆå»ºè®®æ·»åŠ ï¼‰
â”‚           â””â”€â”€ router/    # Vue Router é…ç½®ï¼ˆå»ºè®®æ·»åŠ ï¼‰
â”œâ”€â”€ resources/             # æ‰“åŒ…æ—¶å¤åˆ¶çš„èµ„æº
â”‚   â””â”€â”€ icon.png
â”œâ”€â”€ build/                 # æ„å»ºèµ„æºï¼ˆå›¾æ ‡ã€entitlementsï¼‰
â”‚   â”œâ”€â”€ icon.ico           # Windows å›¾æ ‡
â”‚   â”œâ”€â”€ icon.icns          # macOS å›¾æ ‡
â”‚   â””â”€â”€ icon.png
â”œâ”€â”€ out/                   # æ„å»ºè¾“å‡ºç›®å½•ï¼ˆ.gitignoreï¼‰
â”‚   â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ preload/
â”‚   â””â”€â”€ renderer/
â”œâ”€â”€ doc/                   # ä¸šåŠ¡æ–‡æ¡£
â”‚   â””â”€â”€ doc.md             # äº¤äº’è®¾è®¡è§„èŒƒ
â”œâ”€â”€ electron.vite.config.ts # electron-vite é…ç½®
â”œâ”€â”€ electron-builder.yml   # æ‰“åŒ…é…ç½®
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json          # TypeScript æ ¹é…ç½®
â”œâ”€â”€ tsconfig.node.json     # ä¸»è¿›ç¨‹å’Œé¢„åŠ è½½ TS é…ç½®
â”œâ”€â”€ tsconfig.web.json      # æ¸²æŸ“è¿›ç¨‹ TS é…ç½®
â””â”€â”€ AGENT.md               # æœ¬æ–‡æ¡£
```

### å…³é”®ç›®å½•èŒè´£

#### `src/main/`ï¼ˆä¸»è¿›ç¨‹ï¼‰
- **èŒè´£**ï¼š
  - åˆ›å»ºå’Œç®¡ç† BrowserWindow
  - å¤„ç†æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆè¯»å†™ Excelï¼‰
  - IPC é€šä¿¡æœåŠ¡ç«¯
  - Carbone æ¨¡æ¿æ¸²æŸ“
  - è°ƒç”¨ exceljs è§£ææ•°æ®
  - å­è¿›ç¨‹ç®¡ç†ï¼ˆé€šè¿‡ execaï¼‰
- **ç¯å¢ƒ**ï¼šNode.jsï¼ˆå¯è®¿é—®æ‰€æœ‰ Node API å’Œ Electron ä¸»è¿›ç¨‹ APIï¼‰
- **æ„å»ºç›®æ ‡**ï¼šCommonJSï¼ˆé»˜è®¤ï¼‰æˆ– ESM

#### `src/preload/`ï¼ˆé¢„åŠ è½½è„šæœ¬ï¼‰
- **èŒè´£**ï¼š
  - é€šè¿‡ `contextBridge` æš´éœ²å®‰å…¨çš„ API åˆ°æ¸²æŸ“è¿›ç¨‹
  - å°è£… `ipcRenderer` è°ƒç”¨
- **ç¯å¢ƒ**ï¼šåŒæ—¶è®¿é—®éƒ¨åˆ† Node API å’Œ DOM API
- **å®‰å…¨**ï¼š**å¿…é¡»**å¯ç”¨ `contextIsolation: true`

#### `src/renderer/`ï¼ˆæ¸²æŸ“è¿›ç¨‹ï¼‰
- **èŒè´£**ï¼š
  - ç”¨æˆ·ç•Œé¢ï¼ˆVue ç»„ä»¶ï¼‰
  - çŠ¶æ€ç®¡ç†ï¼ˆPiniaï¼‰
  - è·¯ç”±ï¼ˆVue Routerï¼‰
  - é€šè¿‡é¢„åŠ è½½è„šæœ¬æš´éœ²çš„ API ä¸ä¸»è¿›ç¨‹é€šä¿¡
- **ç¯å¢ƒ**ï¼šChromium æµè§ˆå™¨ç¯å¢ƒï¼ˆ**ä¸èƒ½**ç›´æ¥è®¿é—® Node APIï¼‰
- **æ„å»ºç›®æ ‡**ï¼šESM

---

## æ ¸å¿ƒé…ç½®æ–‡ä»¶

### `electron.vite.config.ts`
electron-vite çš„**ä¸­å¿ƒåŒ–é…ç½®**ï¼Œç®¡ç†ä¸‰ä¸ªè¿›ç¨‹çš„æ„å»ºé€‰é¡¹ã€‚

```typescript
import { resolve } from 'path'
import { defineConfig, externalizeDepsPlugin } from 'electron-vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  // ä¸»è¿›ç¨‹é…ç½®
  main: {
    plugins: [
      // è‡ªåŠ¨å¤–éƒ¨åŒ– package.json ä¸­çš„ dependencies
      externalizeDepsPlugin()
    ],
    build: {
      rollupOptions: {
        input: {
          index: resolve(__dirname, 'src/main/index.ts')
        }
      }
    }
  },

  // é¢„åŠ è½½è„šæœ¬é…ç½®
  preload: {
    plugins: [externalizeDepsPlugin()],
    build: {
      rollupOptions: {
        input: {
          index: resolve(__dirname, 'src/preload/index.ts')
        }
      }
    }
  },

  // æ¸²æŸ“è¿›ç¨‹é…ç½®
  renderer: {
    root: 'src/renderer',
    plugins: [vue()],
    resolve: {
      alias: {
        '@renderer': resolve('src/renderer/src')
      }
    },
    build: {
      rollupOptions: {
        input: {
          index: resolve(__dirname, 'src/renderer/index.html')
        }
      }
    }
  }
})
```

**å…³é”®é…ç½®é¡¹**ï¼š
- `externalizeDepsPlugin()`: é˜²æ­¢ Node.js æ¨¡å—ï¼ˆå¦‚ `exceljs`, `carbone`ï¼‰è¢«æ‰“åŒ…
- `rollupOptions.input`: æŒ‡å®šå…¥å£æ–‡ä»¶
- `resolve.alias`: è·¯å¾„åˆ«åï¼ˆå¦‚ `@renderer`ï¼‰

### `tsconfig.json`ï¼ˆæ ¹é…ç½®ï¼‰
```json
{
  "files": [],
  "references": [
    { "path": "./tsconfig.node.json" },
    { "path": "./tsconfig.web.json" }
  ]
}
```
ä½¿ç”¨ **TypeScript Project References** è¿›è¡Œå¤šé¡¹ç›®ç®¡ç†ã€‚

### `tsconfig.node.json`ï¼ˆä¸»è¿›ç¨‹ + é¢„åŠ è½½ï¼‰
```json
{
  "extends": "@electron-toolkit/tsconfig/tsconfig.node.json",
  "compilerOptions": {
    "composite": true,
    "types": ["electron-vite/node"],
    "outDir": "out/main"
  },
  "include": ["src/main/**/*", "src/preload/**/*", "electron.vite.config.ts"]
}
```

### `tsconfig.web.json`ï¼ˆæ¸²æŸ“è¿›ç¨‹ï¼‰
```json
{
  "extends": "@electron-toolkit/tsconfig/tsconfig.web.json",
  "compilerOptions": {
    "composite": true,
    "types": ["vite/client"],
    "baseUrl": ".",
    "paths": {
      "@renderer/*": ["src/renderer/src/*"]
    }
  },
  "include": ["src/renderer/**/*"]
}
```

### `package.json` è„šæœ¬
```json
{
  "scripts": {
    "dev": "electron-vite dev",              // å¼€å‘æ¨¡å¼ï¼šHMR + ä¸»è¿›ç¨‹çƒ­é‡å¯
    "build": "npm run typecheck && electron-vite build", // ç”Ÿäº§æ„å»º
    "typecheck": "npm run typecheck:node && npm run typecheck:web",
    "typecheck:node": "tsc --noEmit -p tsconfig.node.json --composite false",
    "typecheck:web": "vue-tsc --noEmit -p tsconfig.web.json --composite false",
    "preview": "electron-vite preview",      // é¢„è§ˆç”Ÿäº§æ„å»º
    "build:win": "npm run build && electron-builder --win",
    "build:mac": "npm run build && electron-builder --mac",
    "build:linux": "npm run build && electron-builder --linux"
  }
}
```

---

## å¼€å‘å·¥ä½œæµ

### å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```bash
npm run dev
# æˆ–
pnpm dev
```

**æ•ˆæœ**ï¼š
- æ¸²æŸ“è¿›ç¨‹ï¼šVite å¼€å‘æœåŠ¡å™¨ï¼ˆHMRï¼Œé€šå¸¸ `http://localhost:5173`ï¼‰
- ä¸»è¿›ç¨‹ï¼šè‡ªåŠ¨ç›‘å¬æ–‡ä»¶å˜åŒ–å¹¶é‡å¯
- é¢„åŠ è½½è„šæœ¬ï¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘å¹¶åˆ·æ–°çª—å£

### ç±»å‹æ£€æŸ¥
```bash
npm run typecheck
```
**ä½•æ—¶è¿è¡Œ**ï¼š
- æäº¤ä»£ç å‰
- CI/CD æµæ°´çº¿

### æ„å»ºç”Ÿäº§ç‰ˆæœ¬
```bash
npm run build
```
è¾“å‡ºåˆ° `out/` ç›®å½•ï¼š
```
out/
â”œâ”€â”€ main/
â”‚   â””â”€â”€ index.js       # ä¸»è¿›ç¨‹æ‰“åŒ…åçš„ä»£ç 
â”œâ”€â”€ preload/
â”‚   â””â”€â”€ index.js       # é¢„åŠ è½½è„šæœ¬æ‰“åŒ…åçš„ä»£ç 
â””â”€â”€ renderer/
    â”œâ”€â”€ index.html
    â””â”€â”€ assets/        # æ‰“åŒ…åçš„ CSS/JS
```

### æ‰“åŒ…ä¸ºå¯åˆ†å‘åº”ç”¨
```bash
# Windows å®‰è£…åŒ…
npm run build:win

# macOS åº”ç”¨
npm run build:mac

# Linux åŒ…
npm run build:linux
```

---

## ä»£ç è§„èŒƒä¸æœ€ä½³å®è·µ

### TypeScript è§„èŒƒ

#### 1. ä¸¥æ ¼ç±»å‹å®šä¹‰
```typescript
// âœ… å¥½çš„åšæ³•
interface ReportContract {
  id: string
  name: string
  templatePath: string
  dataSources: DataSource[]
  parameters: RuntimeParameter[]
}

function loadContract(id: string): Promise<ReportContract> {
  // ...
}

// âŒ é¿å… any
function processData(data: any) { // ä¸å¥½
  // ...
}
```

#### 2. ä½¿ç”¨ç±»å‹åˆ«åæé«˜å¯è¯»æ€§
```typescript
type CellCoordinate = `${string}!${string}` // ä¾‹å¦‚ï¼š"Sheet1!E5"
type CarboneMark = `d.${string}` | `v.${string}`

interface DataBinding {
  mark: CarboneMark
  source: string
  coordinate: CellCoordinate
}
```

#### 3. åˆ©ç”¨ Discriminated Unions
```typescript
type MarkType =
  | { type: 'single'; mark: string; coordinate: CellCoordinate }
  | { type: 'list'; mark: string; range: ExcelRange; headerRow: number }
  | { type: 'parameter'; mark: string; label: string; defaultValue?: string }

function processMarkType(mark: MarkType) {
  switch (mark.type) {
    case 'single':
      return processSingleValue(mark.coordinate)
    case 'list':
      return processList(mark.range, mark.headerRow)
    case 'parameter':
      return processParameter(mark.label)
  }
}
```

### Vue 3 ç»„åˆå¼ API è§„èŒƒ

#### 1. ç»„ä»¶ç»“æ„é¡ºåº
```vue
<script setup lang="ts">
// 1. å¯¼å…¥
import { ref, computed, watch, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useReportStore } from '@renderer/stores/report'

// 2. Props å’Œ Emits
interface Props {
  contractId: string
  mode?: 'edit' | 'view'
}
const props = withDefaults(defineProps<Props>(), {
  mode: 'view'
})

const emit = defineEmits<{
  (e: 'save', contract: ReportContract): void
  (e: 'cancel'): void
}>()

// 3. ç»„åˆå¼å‡½æ•°ï¼ˆComposablesï¼‰
const router = useRouter()
const reportStore = useReportStore()

// 4. å“åº”å¼çŠ¶æ€
const contract = ref<ReportContract | null>(null)
const isLoading = ref(false)

// 5. è®¡ç®—å±æ€§
const isValid = computed(() => {
  return contract.value?.dataSources.every(ds => ds.configured) ?? false
})

// 6. æ–¹æ³•
const saveContract = async () => {
  if (!contract.value) return
  await reportStore.saveContract(contract.value)
  emit('save', contract.value)
}

// 7. ç”Ÿå‘½å‘¨æœŸé’©å­
onMounted(async () => {
  isLoading.value = true
  contract.value = await reportStore.loadContract(props.contractId)
  isLoading.value = false
})

// 8. ç›‘å¬å™¨
watch(() => props.contractId, (newId) => {
  // é‡æ–°åŠ è½½å¥‘çº¦
})
</script>

<template>
  <!-- æ¨¡æ¿ -->
</template>

<style scoped>
/* æ ·å¼ */
</style>
```

#### 2. ç»„åˆå¼å‡½æ•°ï¼ˆComposablesï¼‰
```typescript
// src/renderer/src/composables/useFileUpload.ts
import { ref } from 'vue'

export function useFileUpload() {
  const uploadedFile = ref<File | null>(null)
  const uploadProgress = ref(0)
  const error = ref<string | null>(null)

  const uploadFile = async (file: File) => {
    uploadedFile.value = file
    uploadProgress.value = 0
    error.value = null

    try {
      // é€šè¿‡é¢„åŠ è½½è„šæœ¬æš´éœ²çš„ API ä¸Šä¼ 
      const result = await window.electron.uploadFile(file.path)
      uploadProgress.value = 100
      return result
    } catch (e) {
      error.value = e.message
      throw e
    }
  }

  const resetUpload = () => {
    uploadedFile.value = null
    uploadProgress.value = 0
    error.value = null
  }

  return {
    uploadedFile,
    uploadProgress,
    error,
    uploadFile,
    resetUpload
  }
}
```

#### 3. Pinia Store æ¨¡å¼
```typescript
// src/renderer/src/stores/report.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useReportStore = defineStore('report', () => {
  // çŠ¶æ€
  const contracts = ref<ReportContract[]>([])
  const currentContract = ref<ReportContract | null>(null)

  // è®¡ç®—å±æ€§
  const contractCount = computed(() => contracts.value.length)

  const getContractById = computed(() => {
    return (id: string) => contracts.value.find(c => c.id === id)
  })

  // åŠ¨ä½œ
  async function loadContracts() {
    const data = await window.electron.loadContracts()
    contracts.value = data
  }

  async function saveContract(contract: ReportContract) {
    await window.electron.saveContract(contract)
    const index = contracts.value.findIndex(c => c.id === contract.id)
    if (index !== -1) {
      contracts.value[index] = contract
    } else {
      contracts.value.push(contract)
    }
  }

  async function deleteContract(id: string) {
    await window.electron.deleteContract(id)
    const index = contracts.value.findIndex(c => c.id === id)
    if (index !== -1) {
      contracts.value.splice(index, 1)
    }
  }

  return {
    // çŠ¶æ€
    contracts,
    currentContract,
    // è®¡ç®—å±æ€§
    contractCount,
    getContractById,
    // åŠ¨ä½œ
    loadContracts,
    saveContract,
    deleteContract
  }
})
```

### Tailwind CSS ä½¿ç”¨è§„èŒƒ

#### 1. å®ç”¨ç±»ç»„ç»‡é¡ºåº
```vue
<template>
  <!-- æ¨èé¡ºåºï¼šå¸ƒå±€ â†’ é—´è· â†’ å°ºå¯¸ â†’ æ’ç‰ˆ â†’ è§†è§‰ â†’ äº¤äº’ -->
  <div
    class="
      flex flex-col items-center
      p-4 mt-8 mb-4
      w-full max-w-4xl h-screen
      text-lg font-semibold text-gray-900
      bg-white rounded-lg shadow-md
      hover:shadow-lg transition-shadow
      focus:outline-none focus:ring-2 focus:ring-blue-500
    "
  >
    <!-- å†…å®¹ -->
  </div>
</template>
```

#### 2. ä½¿ç”¨ `@apply` æå–é‡å¤æ¨¡å¼
```vue
<style scoped>
.btn-primary {
  @apply px-4 py-2 bg-blue-600 text-white font-medium rounded-md;
  @apply hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500;
  @apply transition-colors duration-200;
}

.card {
  @apply bg-white rounded-lg shadow-md p-6;
}

.input-field {
  @apply w-full px-3 py-2 border border-gray-300 rounded-md;
  @apply focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent;
}
</style>
```

#### 3. å“åº”å¼è®¾è®¡
```vue
<template>
  <!-- ç§»åŠ¨ä¼˜å…ˆ -->
  <div class="
    grid grid-cols-1
    md:grid-cols-2
    lg:grid-cols-3
    xl:grid-cols-4
    gap-4
  ">
    <div class="
      text-sm md:text-base lg:text-lg
      p-2 md:p-4 lg:p-6
    ">
      <!-- å†…å®¹ -->
    </div>
  </div>
</template>
```

---

## Electron ç‰¹å®šæŒ‡å—

### IPC é€šä¿¡æ¨¡å¼

#### 1. ä¸»è¿›ç¨‹ï¼ˆå¤„ç†å™¨ï¼‰
```typescript
// src/main/index.ts
import { app, BrowserWindow, ipcMain } from 'electron'
import { parseExcelTemplate } from './excel-parser'
import { generateReport } from './report-generator'

// å¤„ç†å¼‚æ­¥è¯·æ±‚-å“åº”
ipcMain.handle('parse-template', async (event, templatePath: string) => {
  try {
    const marks = await parseExcelTemplate(templatePath)
    return { success: true, data: marks }
  } catch (error) {
    return { success: false, error: error.message }
  }
})

// å¤„ç†å•å‘æ¶ˆæ¯
ipcMain.on('log-message', (event, message: string) => {
  console.log('[Renderer]:', message)
})

// å‘æ¸²æŸ“è¿›ç¨‹å‘é€æ¶ˆæ¯
function sendProgressUpdate(window: BrowserWindow, progress: number) {
  window.webContents.send('report-progress', progress)
}
```

#### 2. é¢„åŠ è½½è„šæœ¬ï¼ˆæ¡¥æ¥ï¼‰
```typescript
// src/preload/index.ts
import { contextBridge, ipcRenderer } from 'electron'
import { electronAPI } from '@electron-toolkit/preload'

const api = {
  // æš´éœ²å®‰å…¨çš„ IPC æ–¹æ³•
  parseTemplate: (templatePath: string) =>
    ipcRenderer.invoke('parse-template', templatePath),

  generateReport: (contract: ReportContract, data: any) =>
    ipcRenderer.invoke('generate-report', contract, data),

  // æ–‡ä»¶å¯¹è¯æ¡†
  openFileDialog: (options: OpenDialogOptions) =>
    ipcRenderer.invoke('open-file-dialog', options),

  saveFileDialog: (options: SaveDialogOptions) =>
    ipcRenderer.invoke('save-file-dialog', options),

  // ç›‘å¬æ¥è‡ªä¸»è¿›ç¨‹çš„æ¶ˆæ¯
  onReportProgress: (callback: (progress: number) => void) => {
    ipcRenderer.on('report-progress', (event, progress) => callback(progress))
  },

  // ç§»é™¤ç›‘å¬å™¨
  removeReportProgressListener: () => {
    ipcRenderer.removeAllListeners('report-progress')
  }
}

// ä½¿ç”¨ contextBridge æš´éœ² API
if (process.contextIsolated) {
  try {
    contextBridge.exposeInMainWorld('electron', electronAPI)
    contextBridge.exposeInMainWorld('api', api)
  } catch (error) {
    console.error(error)
  }
} else {
  window.electron = electronAPI
  window.api = api
}
```

#### 3. é¢„åŠ è½½ç±»å‹å®šä¹‰
```typescript
// src/preload/index.d.ts
import { ElectronAPI } from '@electron-toolkit/preload'

interface API {
  parseTemplate: (templatePath: string) => Promise<ParseResult>
  generateReport: (contract: ReportContract, data: any) => Promise<GenerateResult>
  openFileDialog: (options: OpenDialogOptions) => Promise<string[]>
  saveFileDialog: (options: SaveDialogOptions) => Promise<string>
  onReportProgress: (callback: (progress: number) => void) => void
  removeReportProgressListener: () => void
}

declare global {
  interface Window {
    electron: ElectronAPI
    api: API
  }
}
```

#### 4. æ¸²æŸ“è¿›ç¨‹ï¼ˆè°ƒç”¨ï¼‰
```vue
<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'

const progress = ref(0)

// è°ƒç”¨ä¸»è¿›ç¨‹æ–¹æ³•
const handleParseTemplate = async () => {
  const result = await window.api.parseTemplate('/path/to/template.xlsx')
  if (result.success) {
    console.log('è§£æç»“æœ:', result.data)
  } else {
    console.error('è§£æå¤±è´¥:', result.error)
  }
}

// ç›‘å¬ä¸»è¿›ç¨‹æ¶ˆæ¯
const handleProgress = (value: number) => {
  progress.value = value
}

onMounted(() => {
  window.api.onReportProgress(handleProgress)
})

onUnmounted(() => {
  window.api.removeReportProgressListener()
})
</script>
```

### å®‰å…¨æœ€ä½³å®è·µ

#### 1. å¿…é¡»å¯ç”¨çš„å®‰å…¨é€‰é¡¹
```typescript
// src/main/index.ts
const createWindow = () => {
  const win = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      preload: path.join(__dirname, '../preload/index.js'),

      // âœ… å¿…é¡»å¯ç”¨
      contextIsolation: true,    // éš”ç¦»æ¸²æŸ“è¿›ç¨‹ä¸Šä¸‹æ–‡
      nodeIntegration: false,    // ç¦æ­¢æ¸²æŸ“è¿›ç¨‹ç›´æ¥ä½¿ç”¨ Node.js
      sandbox: true,             // å¯ç”¨æ²™ç›’æ¨¡å¼

      // âœ… å®‰å…¨è®¾ç½®
      webSecurity: true,         // å¯ç”¨åŒæºç­–ç•¥
      allowRunningInsecureContent: false,

      // âœ… ç¦ç”¨è¿œç¨‹æ¨¡å—
      enableRemoteModule: false
    }
  })
}
```

#### 2. éªŒè¯ IPC è¾“å…¥
```typescript
// src/main/index.ts
import { z } from 'zod' // æ¨èä½¿ç”¨ zod è¿›è¡ŒéªŒè¯

const ContractSchema = z.object({
  id: z.string().uuid(),
  name: z.string().min(1).max(100),
  templatePath: z.string().refine(path => {
    // éªŒè¯è·¯å¾„å®‰å…¨æ€§
    const normalized = path.normalize(templatePath)
    return !normalized.includes('..') // é˜²æ­¢è·¯å¾„éå†
  })
})

ipcMain.handle('save-contract', async (event, contract: unknown) => {
  try {
    // éªŒè¯è¾“å…¥
    const validContract = ContractSchema.parse(contract)

    // å¤„ç†ä¸šåŠ¡é€»è¾‘
    await saveContractToFile(validContract)

    return { success: true }
  } catch (error) {
    return { success: false, error: error.message }
  }
})
```

#### 3. å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰
```html
<!-- src/renderer/index.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data:;" />
  <title>å›½å¯Œ Excel å·¥å…·</title>
</head>
<body>
  <div id="app"></div>
  <script type="module" src="/src/main.ts"></script>
</body>
</html>
```

### æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

#### 1. å®‰å…¨çš„æ–‡ä»¶è·¯å¾„å¤„ç†
```typescript
// src/main/file-operations.ts
import path from 'path'
import fs from 'fs/promises'
import { app } from 'electron'

// è·å–å®‰å…¨çš„ç”¨æˆ·æ•°æ®ç›®å½•
const getUserDataPath = () => app.getPath('userData')

// å®‰å…¨åœ°æ„å»ºæ–‡ä»¶è·¯å¾„
export function getSafeContractPath(filename: string): string {
  // ç§»é™¤ä¸å®‰å…¨å­—ç¬¦
  const safeName = filename.replace(/[^a-z0-9_\-\.]/gi, '_')
  // é™åˆ¶åœ¨ç”¨æˆ·æ•°æ®ç›®å½•å†…
  return path.join(getUserDataPath(), 'contracts', safeName)
}

// è¯»å–å¥‘çº¦æ–‡ä»¶
export async function loadContract(contractId: string): Promise<ReportContract> {
  const filePath = getSafeContractPath(`${contractId}.json`)

  try {
    const data = await fs.readFile(filePath, 'utf-8')
    return JSON.parse(data)
  } catch (error) {
    throw new Error(`æ— æ³•åŠ è½½å¥‘çº¦ ${contractId}: ${error.message}`)
  }
}

// ä¿å­˜å¥‘çº¦æ–‡ä»¶
export async function saveContract(contract: ReportContract): Promise<void> {
  const filePath = getSafeContractPath(`${contract.id}.json`)

  // ç¡®ä¿ç›®å½•å­˜åœ¨
  await fs.mkdir(path.dirname(filePath), { recursive: true })

  // å†™å…¥æ–‡ä»¶
  await fs.writeFile(filePath, JSON.stringify(contract, null, 2), 'utf-8')
}
```

#### 2. æ–‡ä»¶å¯¹è¯æ¡†
```typescript
// src/main/index.ts
import { dialog } from 'electron'

ipcMain.handle('open-file-dialog', async (event, options) => {
  const result = await dialog.showOpenDialog({
    properties: ['openFile'],
    filters: [
      { name: 'Excel æ–‡ä»¶', extensions: ['xlsx', 'xls'] },
      { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }
    ],
    ...options
  })

  return result.filePaths
})

ipcMain.handle('save-file-dialog', async (event, options) => {
  const result = await dialog.showSaveDialog({
    filters: [
      { name: 'Excel æ–‡ä»¶', extensions: ['xlsx'] }
    ],
    ...options
  })

  return result.filePath
})
```

---

## å‰ç«¯å¼€å‘æŒ‡å—

### é¡µé¢è·¯ç”±ç»“æ„ï¼ˆå»ºè®®ï¼‰

```typescript
// src/renderer/src/router/index.ts
import { createRouter, createWebHashHistory } from 'vue-router'

const router = createRouter({
  // ä½¿ç”¨ hash æ¨¡å¼ï¼ˆElectron æ¨èï¼‰
  history: createWebHashHistory(),
  routes: [
    {
      path: '/',
      name: 'dashboard',
      component: () => import('@renderer/views/Dashboard.vue')
    },
    {
      path: '/create-contract',
      name: 'create-contract',
      component: () => import('@renderer/views/CreateContract.vue'),
      children: [
        {
          path: 'upload',
          name: 'upload-template',
          component: () => import('@renderer/views/contract-steps/UploadTemplate.vue')
        },
        {
          path: 'configure',
          name: 'configure-contract',
          component: () => import('@renderer/views/contract-steps/ConfigureContract.vue')
        },
        {
          path: 'test',
          name: 'test-contract',
          component: () => import('@renderer/views/contract-steps/TestContract.vue')
        }
      ]
    },
    {
      path: '/run-contract/:id',
      name: 'run-contract',
      component: () => import('@renderer/views/RunContract.vue')
    },
    {
      path: '/edit-contract/:id',
      name: 'edit-contract',
      component: () => import('@renderer/views/EditContract.vue')
    }
  ]
})

export default router
```

### UI ç»„ä»¶åº“æ¨è

è€ƒè™‘åˆ° Tailwind CSS 4.x çš„ä½¿ç”¨ï¼Œæ¨èä»¥ä¸‹ç»„ä»¶åº“ï¼š

1. **Headless UI**ï¼ˆå®˜æ–¹æ¨èï¼‰
   ```bash
   npm install @headlessui/vue
   ```
   - æ— æ ·å¼ã€å¯è®¿é—®çš„ UI ç»„ä»¶
   - å®Œç¾é…åˆ Tailwind CSS

2. **Radix Vue**ï¼ˆç¤¾åŒºé€‰æ‹©ï¼‰
   ```bash
   npm install radix-vue
   ```
   - Vue 3 çš„ Radix UI ç§»æ¤
   - å¼ºå¤§çš„å¯è®¿é—®æ€§

3. **è‡ªå®šä¹‰ç»„ä»¶åº“**
   åˆ›å»º `src/renderer/src/components/ui/` ç›®å½•å­˜æ”¾é€šç”¨ç»„ä»¶ï¼š
   - `Button.vue`
   - `Input.vue`
   - `Select.vue`
   - `Modal.vue`
   - `Card.vue`
   - `Spinner.vue`

### è¡¨å•å¤„ç†

```vue
<script setup lang="ts">
import { ref, computed } from 'vue'
import { z } from 'zod'

// å®šä¹‰è¡¨å•æ¨¡å¼
const contractSchema = z.object({
  name: z.string().min(1, 'å¥‘çº¦åç§°ä¸èƒ½ä¸ºç©º').max(100, 'åç§°è¿‡é•¿'),
  description: z.string().optional()
})

type ContractForm = z.infer<typeof contractSchema>

// è¡¨å•çŠ¶æ€
const form = ref<ContractForm>({
  name: '',
  description: ''
})

// éªŒè¯é”™è¯¯
const errors = ref<Partial<Record<keyof ContractForm, string>>>({})

// è¡¨å•éªŒè¯
const validateForm = (): boolean => {
  errors.value = {}

  try {
    contractSchema.parse(form.value)
    return true
  } catch (error) {
    if (error instanceof z.ZodError) {
      error.errors.forEach(err => {
        const field = err.path[0] as keyof ContractForm
        errors.value[field] = err.message
      })
    }
    return false
  }
}

// æäº¤å¤„ç†
const handleSubmit = async () => {
  if (!validateForm()) return

  try {
    await window.api.saveContract(form.value)
    // è·³è½¬æˆ–æç¤ºæˆåŠŸ
  } catch (error) {
    console.error('ä¿å­˜å¤±è´¥:', error)
  }
}
</script>

<template>
  <form @submit.prevent="handleSubmit" class="space-y-4">
    <div>
      <label for="name" class="block text-sm font-medium text-gray-700">
        å¥‘çº¦åç§° <span class="text-red-500">*</span>
      </label>
      <input
        id="name"
        v-model="form.name"
        type="text"
        class="mt-1 input-field"
        :class="{ 'border-red-500': errors.name }"
      />
      <p v-if="errors.name" class="mt-1 text-sm text-red-600">
        {{ errors.name }}
      </p>
    </div>

    <div>
      <label for="description" class="block text-sm font-medium text-gray-700">
        æè¿°
      </label>
      <textarea
        id="description"
        v-model="form.description"
        rows="3"
        class="mt-1 input-field"
      />
    </div>

    <button type="submit" class="btn-primary">
      ä¿å­˜å¥‘çº¦
    </button>
  </form>
</template>
```

### æ‹–æ‹½ä¸Šä¼ ç»„ä»¶

```vue
<script setup lang="ts">
import { ref } from 'vue'

const emit = defineEmits<{
  (e: 'upload', file: File): void
}>()

const isDragging = ref(false)
const fileInput = ref<HTMLInputElement | null>(null)

const handleDragEnter = (e: DragEvent) => {
  e.preventDefault()
  isDragging.value = true
}

const handleDragLeave = (e: DragEvent) => {
  e.preventDefault()
  isDragging.value = false
}

const handleDrop = (e: DragEvent) => {
  e.preventDefault()
  isDragging.value = false

  const files = e.dataTransfer?.files
  if (files && files.length > 0) {
    emit('upload', files[0])
  }
}

const handleFileSelect = (e: Event) => {
  const target = e.target as HTMLInputElement
  const files = target.files
  if (files && files.length > 0) {
    emit('upload', files[0])
  }
}

const triggerFileSelect = () => {
  fileInput.value?.click()
}
</script>

<template>
  <div
    class="
      relative border-2 border-dashed rounded-lg p-8 text-center
      transition-colors duration-200
    "
    :class="{
      'border-blue-500 bg-blue-50': isDragging,
      'border-gray-300 hover:border-gray-400': !isDragging
    }"
    @dragenter="handleDragEnter"
    @dragover.prevent
    @dragleave="handleDragLeave"
    @drop="handleDrop"
  >
    <input
      ref="fileInput"
      type="file"
      class="hidden"
      accept=".xlsx,.xls"
      @change="handleFileSelect"
    />

    <div class="space-y-2">
      <svg
        class="mx-auto h-12 w-12 text-gray-400"
        stroke="currentColor"
        fill="none"
        viewBox="0 0 48 48"
      >
        <path
          d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>

      <div class="text-sm text-gray-600">
        <button
          type="button"
          class="font-medium text-blue-600 hover:text-blue-500"
          @click="triggerFileSelect"
        >
          é€‰æ‹©æ–‡ä»¶
        </button>
        æˆ–æ‹–æ‹½åˆ°æ­¤å¤„
      </div>

      <p class="text-xs text-gray-500">
        æ”¯æŒ .xlsx, .xls æ ¼å¼
      </p>
    </div>
  </div>
</template>
```

---

## åç«¯å¤„ç†æŒ‡å—

### Carbone æ¨¡æ¿å¼•æ“é›†æˆ

```typescript
// src/main/carbone-engine.ts
import carbone from 'carbone'
import fs from 'fs/promises'
import path from 'path'

interface CarboneRenderOptions {
  templatePath: string
  data: Record<string, any>
  outputPath: string
}

export async function renderReport(options: CarboneRenderOptions): Promise<string> {
  const { templatePath, data, outputPath } = options

  return new Promise((resolve, reject) => {
    carbone.render(templatePath, data, (err, result) => {
      if (err) {
        reject(new Error(`Carbone æ¸²æŸ“å¤±è´¥: ${err.message}`))
        return
      }

      fs.writeFile(outputPath, result)
        .then(() => resolve(outputPath))
        .catch(reject)
    })
  })
}

// è§£ææ¨¡æ¿ä¸­çš„æ ‡è®°
export async function parseTemplateMarks(templatePath: string): Promise<{
  dataMarks: string[]      // d.* æ ‡è®°
  variableMarks: string[]  // v.* æ ‡è®°
}> {
  const content = await fs.readFile(templatePath)

  // æ­£åˆ™åŒ¹é… {{d.*}} å’Œ {{v.*}}
  const dataMarkRegex = /\{\{\s*d\.([a-zA-Z0-9_\[\]\.]+)\s*\}\}/g
  const variableMarkRegex = /\{\{\s*v\.([a-zA-Z0-9_]+)\s*\}\}/g

  const dataMarks: Set<string> = new Set()
  const variableMarks: Set<string> = new Set()

  // æ³¨æ„ï¼šå®é™…å®ç°éœ€è¦ä½¿ç”¨ exceljs è¯»å– Excel å•å…ƒæ ¼å†…å®¹
  // è¿™é‡Œç®€åŒ–å±•ç¤ºé€»è¾‘

  return {
    dataMarks: Array.from(dataMarks),
    variableMarks: Array.from(variableMarks)
  }
}
```

### ExcelJS æ•°æ®æå–

```typescript
// src/main/excel-parser.ts
import ExcelJS from 'exceljs'

export interface CellData {
  value: any
  address: string // ä¾‹å¦‚ "A1"
  type: 'string' | 'number' | 'date' | 'boolean' | 'formula'
}

export interface SheetData {
  name: string
  rows: CellData[][]
}

// è¯»å– Excel æ–‡ä»¶
export async function readExcelFile(filePath: string): Promise<SheetData[]> {
  const workbook = new ExcelJS.Workbook()
  await workbook.xlsx.readFile(filePath)

  const sheets: SheetData[] = []

  workbook.eachSheet((worksheet, sheetId) => {
    const rows: CellData[][] = []

    worksheet.eachRow({ includeEmpty: true }, (row, rowNumber) => {
      const cells: CellData[] = []

      row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
        cells.push({
          value: cell.value,
          address: cell.address,
          type: getCellType(cell)
        })
      })

      rows.push(cells)
    })

    sheets.push({
      name: worksheet.name,
      rows
    })
  })

  return sheets
}

function getCellType(cell: ExcelJS.Cell): CellData['type'] {
  if (cell.type === ExcelJS.ValueType.String) return 'string'
  if (cell.type === ExcelJS.ValueType.Number) return 'number'
  if (cell.type === ExcelJS.ValueType.Date) return 'date'
  if (cell.type === ExcelJS.ValueType.Boolean) return 'boolean'
  if (cell.type === ExcelJS.ValueType.Formula) return 'formula'
  return 'string'
}

// æ ¹æ®é…ç½®æå–æ•°æ®
export async function extractDataByContract(
  filePath: string,
  bindings: DataBinding[]
): Promise<Record<string, any>> {
  const workbook = new ExcelJS.Workbook()
  await workbook.xlsx.readFile(filePath)

  const result: Record<string, any> = {}

  for (const binding of bindings) {
    if (binding.type === 'single') {
      // æå–å•ä¸ªå€¼
      const [sheetName, cellAddress] = binding.coordinate.split('!')
      const worksheet = workbook.getWorksheet(sheetName)
      const cell = worksheet?.getCell(cellAddress)

      result[binding.mark.replace('d.', '')] = cell?.value

    } else if (binding.type === 'list') {
      // æå–åˆ—è¡¨æ•°æ®
      const [sheetName] = binding.coordinate.split('!')
      const worksheet = workbook.getWorksheet(sheetName)

      if (!worksheet) continue

      const headerRow = worksheet.getRow(binding.headerRow)
      const headers = headerRow.values as any[]

      // æ„å»ºåˆ—æ˜ å°„
      const columnMap = new Map<string, number>()
      binding.fieldMappings.forEach(mapping => {
        const colIndex = headers.indexOf(mapping.headerText)
        if (colIndex !== -1) {
          columnMap.set(mapping.fieldName, colIndex)
        }
      })

      // æå–æ•°æ®è¡Œ
      const rows: any[] = []
      for (let i = binding.dataStartRow; i <= worksheet.rowCount; i++) {
        const row = worksheet.getRow(i)
        const rowData: any = {}

        columnMap.forEach((colIndex, fieldName) => {
          rowData[fieldName] = row.getCell(colIndex).value
        })

        // å¦‚æœè¡Œä¸ºç©ºåˆ™åœæ­¢
        if (Object.values(rowData).every(v => !v)) break

        rows.push(rowData)
      }

      result[binding.mark.replace('d.', '').replace('[]', '')] = rows
    }
  }

  return result
}
```

### Execa å­è¿›ç¨‹ç®¡ç†

```typescript
// src/main/process-manager.ts
import { execa } from 'execa'

// æ‰§è¡Œå¤–éƒ¨å‘½ä»¤ï¼ˆä¾‹å¦‚è°ƒç”¨ Python è„šæœ¬ï¼‰
export async function executePythonScript(
  scriptPath: string,
  args: string[]
): Promise<string> {
  try {
    const { stdout, stderr } = await execa('python', [scriptPath, ...args], {
      cwd: process.cwd(),
      timeout: 30000 // 30 ç§’è¶…æ—¶
    })

    if (stderr) {
      console.warn('Python è„šæœ¬è­¦å‘Š:', stderr)
    }

    return stdout
  } catch (error) {
    throw new Error(`æ‰§è¡Œ Python è„šæœ¬å¤±è´¥: ${error.message}`)
  }
}

// æ‰§è¡Œå‘½ä»¤å¹¶è¿”å›æµå¼è¾“å‡º
export async function executeWithProgress(
  command: string,
  args: string[],
  onProgress: (line: string) => void
): Promise<void> {
  const subprocess = execa(command, args)

  subprocess.stdout?.on('data', (data) => {
    const lines = data.toString().split('\n')
    lines.forEach(line => {
      if (line.trim()) {
        onProgress(line)
      }
    })
  })

  await subprocess
}
```

---

## æ„å»ºä¸åˆ†å‘

### electron-builder é…ç½®

```yaml
# electron-builder.yml
appId: com.guofu.excel-tool
productName: å›½å¯ŒExcelå·¥å…·
copyright: Copyright Â© 2025 å›½å¯Œå…¬å¸

directories:
  buildResources: build
  output: dist

files:
  - out/**/*
  - resources/**/*
  - package.json
  - node_modules/**/*
  - "!**/{.DS_Store,.git,.hg,.svn,CVS,RCS,SCCS,__pycache__,thumbs.db,.gitignore,.gitattributes,.editorconfig,.eslintrc,.prettierrc,tsconfig*.json,*.md}"

# Windows é…ç½®
win:
  target:
    - target: nsis
      arch:
        - x64
  icon: build/icon.ico
  artifactName: ${productName}-${version}-win-${arch}.${ext}

nsis:
  oneClick: false
  allowToChangeInstallationDirectory: true
  perMachine: true
  createDesktopShortcut: true
  createStartMenuShortcut: true
  shortcutName: ${productName}

# macOS é…ç½®
mac:
  target:
    - dmg
    - zip
  category: public.app-category.productivity
  icon: build/icon.icns
  hardenedRuntime: true
  gatekeeperAssess: false
  entitlements: build/entitlements.mac.plist
  entitlementsInherit: build/entitlements.mac.plist
  artifactName: ${productName}-${version}-mac-${arch}.${ext}

dmg:
  title: ${productName} ${version}
  icon: build/icon.icns
  contents:
    - x: 410
      y: 150
      type: link
      path: /Applications
    - x: 130
      y: 150
      type: file

# Linux é…ç½®
linux:
  target:
    - AppImage
    - deb
    - rpm
  icon: build/icon.png
  category: Office
  artifactName: ${productName}-${version}-linux-${arch}.${ext}

# å‘å¸ƒé…ç½®
publish:
  provider: generic
  url: https://your-update-server.com/releases
```

### ASAR æ‰“åŒ…æ’é™¤ï¼ˆåŸç”Ÿæ¨¡å—ï¼‰

å¦‚æœä½¿ç”¨éœ€è¦è§£å‹çš„åŸç”Ÿæ¨¡å—ï¼š

```yaml
# electron-builder.yml æ·»åŠ 
asarUnpack:
  - node_modules/better-sqlite3/**/*
  - node_modules/node-pty/**/*
  - resources/**/*
```

### ä»£ç ç­¾åï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

#### Windows
```yaml
win:
  certificateFile: path/to/cert.pfx
  certificatePassword: ${env.CERTIFICATE_PASSWORD}
  signingHashAlgorithms:
    - sha256
  timeStampServer: http://timestamp.digicert.com
```

#### macOS
```yaml
mac:
  identity: "Developer ID Application: Your Name (TEAM_ID)"
  provisioningProfile: path/to/profile.provisionprofile
```

ç¯å¢ƒå˜é‡ï¼š
```bash
# macOS ç­¾å
export APPLE_ID=your@email.com
export APPLE_ID_PASSWORD=@keychain:AC_PASSWORD
export APPLE_TEAM_ID=YOUR_TEAM_ID
```

---

## å¸¸è§ä»»åŠ¡å‚è€ƒ

### æ·»åŠ æ–°çš„ IPC é€šé“

1. **ä¸»è¿›ç¨‹æ·»åŠ å¤„ç†å™¨**ï¼š
```typescript
// src/main/index.ts
ipcMain.handle('new-feature', async (event, arg) => {
  // å¤„ç†é€»è¾‘
  return result
})
```

2. **é¢„åŠ è½½è„šæœ¬æš´éœ² API**ï¼š
```typescript
// src/preload/index.ts
const api = {
  // ...
  newFeature: (arg: ArgType) => ipcRenderer.invoke('new-feature', arg)
}
```

3. **æ›´æ–°ç±»å‹å®šä¹‰**ï¼š
```typescript
// src/preload/index.d.ts
interface API {
  // ...
  newFeature: (arg: ArgType) => Promise<ResultType>
}
```

4. **æ¸²æŸ“è¿›ç¨‹è°ƒç”¨**ï¼š
```typescript
const result = await window.api.newFeature(arg)
```

### æ·»åŠ æ–°çš„ Vue é¡µé¢

1. **åˆ›å»ºé¡µé¢ç»„ä»¶**ï¼š
```bash
# src/renderer/src/views/NewPage.vue
```

2. **æ·»åŠ è·¯ç”±**ï¼š
```typescript
// src/renderer/src/router/index.ts
{
  path: '/new-page',
  name: 'new-page',
  component: () => import('@renderer/views/NewPage.vue')
}
```

3. **æ·»åŠ å¯¼èˆª**ï¼š
```vue
<router-link to="/new-page">æ–°é¡µé¢</router-link>
```

### æ·»åŠ ç¯å¢ƒå˜é‡

1. **åˆ›å»º `.env` æ–‡ä»¶**ï¼š
```bash
# .env.development
MAIN_VITE_API_URL=http://localhost:3000
RENDERER_VITE_API_URL=http://localhost:3000
```

2. **è®¿é—®ç¯å¢ƒå˜é‡**ï¼š
```typescript
// ä¸»è¿›ç¨‹
const apiUrl = import.meta.env.MAIN_VITE_API_URL

// æ¸²æŸ“è¿›ç¨‹
const apiUrl = import.meta.env.RENDERER_VITE_API_URL
```

3. **ç±»å‹å®šä¹‰**ï¼š
```typescript
// src/env.d.ts
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly MAIN_VITE_API_URL: string
  readonly RENDERER_VITE_API_URL: string
}

interface ImportMeta {
  readonly env: ImportMetaEnv
}
```

### è°ƒè¯•æŠ€å·§

#### ä¸»è¿›ç¨‹è°ƒè¯•ï¼ˆVSCodeï¼‰
```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "è°ƒè¯•ä¸»è¿›ç¨‹",
      "type": "node",
      "request": "launch",
      "cwd": "${workspaceRoot}",
      "runtimeExecutable": "${workspaceRoot}/node_modules/.bin/electron-vite",
      "windows": {
        "runtimeExecutable": "${workspaceRoot}/node_modules/.bin/electron-vite.cmd"
      },
      "runtimeArgs": ["--sourcemap"],
      "env": {
        "REMOTE_DEBUGGING_PORT": "9222"
      }
    },
    {
      "name": "è°ƒè¯•æ¸²æŸ“è¿›ç¨‹",
      "type": "chrome",
      "request": "attach",
      "port": 9222,
      "webRoot": "${workspaceFolder}/src/renderer",
      "timeout": 60000
    }
  ],
  "compounds": [
    {
      "name": "è°ƒè¯•å…¨éƒ¨",
      "configurations": ["è°ƒè¯•ä¸»è¿›ç¨‹", "è°ƒè¯•æ¸²æŸ“è¿›ç¨‹"]
    }
  ]
}
```

#### æ¸²æŸ“è¿›ç¨‹è°ƒè¯•
å¼€å‘æ¨¡å¼ä¸‹æŒ‰ `Ctrl+Shift+I`ï¼ˆWindows/Linuxï¼‰æˆ– `Cmd+Option+I`ï¼ˆmacOSï¼‰æ‰“å¼€ DevToolsã€‚

#### ä¸»è¿›ç¨‹æ—¥å¿—
```typescript
// src/main/index.ts
import log from 'electron-log'

log.info('åº”ç”¨å¯åŠ¨')
log.error('é”™è¯¯ä¿¡æ¯', error)

// æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š
// Windows: %USERPROFILE%\AppData\Roaming\<app-name>\logs\main.log
// macOS: ~/Library/Logs/<app-name>/main.log
// Linux: ~/.config/<app-name>/logs/main.log
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. æ¸²æŸ“è¿›ç¨‹æ— æ³•è®¿é—® Node.js API
**é”™è¯¯**ï¼š`require is not defined`

**åŸå› **ï¼šæœªæ­£ç¡®é…ç½®é¢„åŠ è½½è„šæœ¬æˆ– `contextIsolation: false`

**è§£å†³**ï¼š
- ç¡®ä¿ `contextIsolation: true`
- é€šè¿‡é¢„åŠ è½½è„šæœ¬çš„ `contextBridge` æš´éœ² API
- ä¸è¦åœ¨æ¸²æŸ“è¿›ç¨‹ç›´æ¥ä½¿ç”¨ `require` æˆ– Node.js API

#### 2. IPC é€šä¿¡å¤±è´¥
**é”™è¯¯**ï¼š`Error: An object could not be cloned`

**åŸå› **ï¼šIPC ä¼ é€’çš„å¯¹è±¡åŒ…å«ä¸å¯åºåˆ—åŒ–çš„å†…å®¹ï¼ˆå¦‚å‡½æ•°ã€å¾ªç¯å¼•ç”¨ï¼‰

**è§£å†³**ï¼š
- åªä¼ é€’çº¯æ•°æ®å¯¹è±¡ï¼ˆJSON å¯åºåˆ—åŒ–ï¼‰
- ç§»é™¤å‡½æ•°ã€Symbolã€å¾ªç¯å¼•ç”¨

#### 3. æ‰“åŒ…åæ‰¾ä¸åˆ°æ¨¡å—
**é”™è¯¯**ï¼š`Cannot find module 'xxx'`

**åŸå› **ï¼š
- åŸç”Ÿæ¨¡å—æœªæ­£ç¡®æ‰“åŒ…
- åŠ¨æ€ `require` æœªè¢« Rollup è¯†åˆ«

**è§£å†³**ï¼š
- ä½¿ç”¨ `externalizeDepsPlugin()` å¤–éƒ¨åŒ–ä¾èµ–
- æ·»åŠ åˆ° `asarUnpack`ï¼ˆå¦‚æœæ˜¯åŸç”Ÿæ¨¡å—ï¼‰
- é¿å…ä½¿ç”¨åŠ¨æ€ `require`

#### 4. çƒ­é‡è½½ä¸ç”Ÿæ•ˆ
**åŸå› **ï¼š
- æ–‡ä»¶ç›‘å¬å¤±è´¥
- é…ç½®é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ¸…é™¤ç¼“å­˜å¹¶é‡å¯
rm -rf node_modules/.vite
npm run dev
```

#### 5. TypeScript ç±»å‹é”™è¯¯
**é”™è¯¯**ï¼š`Property 'api' does not exist on type 'Window'`

**åŸå› **ï¼šç¼ºå°‘ç±»å‹å®šä¹‰

**è§£å†³**ï¼š
- ç¡®ä¿ `src/preload/index.d.ts` å­˜åœ¨
- åœ¨æ¸²æŸ“è¿›ç¨‹æ·»åŠ  `/// <reference types="@electron-toolkit/preload" />`

#### 6. Tailwind CSS æ ·å¼ä¸ç”Ÿæ•ˆ
**åŸå› **ï¼šé…ç½®é”™è¯¯æˆ–æœªæ‰«æåˆ°æ–‡ä»¶

**è§£å†³**ï¼š
```javascript
// tailwind.config.js
export default {
  content: [
    './src/renderer/index.html',
    './src/renderer/src/**/*.{vue,js,ts,jsx,tsx}'
  ],
  // ...
}
```

#### 7. Vite æ„å»ºé”™è¯¯ï¼š`Top-level await is not available`
**åŸå› **ï¼šç›®æ ‡ç¯å¢ƒä¸æ”¯æŒ top-level await

**è§£å†³**ï¼š
```typescript
// electron.vite.config.ts
export default defineConfig({
  renderer: {
    build: {
      target: 'esnext' // æˆ– 'chrome100'
    }
  }
})
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ä»£ç åˆ†å‰²
```typescript
// è·¯ç”±æ‡’åŠ è½½
const routes = [
  {
    path: '/heavy-page',
    component: () => import('@renderer/views/HeavyPage.vue')
  }
]

// ç»„ä»¶æ‡’åŠ è½½
const HeavyComponent = defineAsyncComponent(() =>
  import('@renderer/components/HeavyComponent.vue')
)
```

### 2. ä¼˜åŒ– IPC é€šä¿¡
```typescript
// âŒ é¢‘ç¹é€šä¿¡
for (let i = 0; i < 1000; i++) {
  await window.api.saveItem(items[i])
}

// âœ… æ‰¹é‡é€šä¿¡
await window.api.saveItems(items)
```

### 3. ä¸»è¿›ç¨‹é¿å…é˜»å¡
```typescript
// âŒ åŒæ­¥æ“ä½œ
const data = fs.readFileSync(path)

// âœ… å¼‚æ­¥æ“ä½œ
const data = await fs.promises.readFile(path)

// âœ… ä½¿ç”¨ Worker Threads å¤„ç† CPU å¯†é›†ä»»åŠ¡
import { Worker } from 'worker_threads'

const worker = new Worker('./worker.js')
worker.postMessage(data)
```

### 4. å‡å°æ‰“åŒ…ä½“ç§¯
```bash
# åˆ†æåŒ…å¤§å°
npm run build
npx vite-bundle-visualizer

# ç§»é™¤æœªä½¿ç”¨çš„ä¾èµ–
npm prune --production

# ä½¿ç”¨ Tree Shaking
# Vite é»˜è®¤å¯ç”¨ï¼Œç¡®ä¿ä½¿ç”¨ ESM å¯¼å…¥
```

---

## å›¢é˜Ÿåä½œè§„èŒƒ

### Git æäº¤è§„èŒƒ
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**:
- `feat`: æ–°åŠŸèƒ½
- `fix`: ä¿®å¤ bug
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰
- `refactor`: é‡æ„
- `perf`: æ€§èƒ½ä¼˜åŒ–
- `test`: æµ‹è¯•
- `chore`: æ„å»º/å·¥å…·é“¾

**ç¤ºä¾‹**:
```
feat(renderer): æ·»åŠ æŠ¥è¡¨é¢„è§ˆåŠŸèƒ½

åœ¨è¿è¡ŒæŠ¥è¡¨é¡µé¢æ·»åŠ é¢„è§ˆåŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥åœ¨ç”Ÿæˆå‰æŸ¥çœ‹æ•ˆæœ

Closes #123
```

### ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•
- [ ] TypeScript ç±»å‹å®Œæ•´
- [ ] æ—  ESLint/Prettier é”™è¯¯
- [ ] IPC é€šä¿¡å®‰å…¨ï¼ˆè¾“å…¥éªŒè¯ï¼‰
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ·»åŠ å¿…è¦æ³¨é‡Š
- [ ] æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½è€ƒé‡

### æ–‡æ¡£æ›´æ–°
ä¿®æ”¹ä»£ç æ—¶ï¼ŒåŒæ­¥æ›´æ–°ï¼š
- API å˜æ›´ â†’ æ›´æ–°ç±»å‹å®šä¹‰
- æ–°åŠŸèƒ½ â†’ æ›´æ–° README
- æ¶æ„å˜æ›´ â†’ æ›´æ–° AGENT.md

---

## é™„å½•

### æ¨è VSCode æ‰©å±•
- **Vue - Official**ï¼ˆVolarï¼‰
- **TypeScript Vue Plugin (Volar)**
- **ESLint**
- **Prettier**
- **Tailwind CSS IntelliSense**
- **Path Intellisense**
- **Auto Rename Tag**

### æ¨èå­¦ä¹ èµ„æº
- [Electron å®˜æ–¹æ–‡æ¡£](https://www.electronjs.org/docs/latest)
- [electron-vite å®˜æ–¹æ–‡æ¡£](https://electron-vite.org/)
- [Vue 3 å®˜æ–¹æ–‡æ¡£](https://vuejs.org/)
- [Tailwind CSS æ–‡æ¡£](https://tailwindcss.com/)
- [Vite å®˜æ–¹æ–‡æ¡£](https://vitejs.dev/)

### é¡¹ç›®ä¾èµ–æ¸…å•ï¼ˆå»ºè®®è¡¥å……ï¼‰

#### ç”Ÿäº§ä¾èµ–
```json
{
  "dependencies": {
    "@electron-toolkit/preload": "^3.0.2",
    "@electron-toolkit/utils": "^4.0.0",
    "carbone": "^3.5.4",
    "exceljs": "^4.4.0",
    "execa": "^8.0.1",
    "pinia": "^2.1.7",
    "vue": "^3.5.21",
    "vue-router": "^4.4.0"
  }
}
```

#### å¼€å‘ä¾èµ–
```json
{
  "devDependencies": {
    "@electron-toolkit/eslint-config-prettier": "3.0.0",
    "@electron-toolkit/eslint-config-ts": "^3.1.0",
    "@electron-toolkit/tsconfig": "^2.0.0",
    "@types/node": "^22.18.6",
    "@vitejs/plugin-vue": "^6.0.1",
    "electron": "^38.1.2",
    "electron-builder": "^25.1.8",
    "electron-vite": "^4.0.1",
    "eslint": "^9.36.0",
    "eslint-plugin-vue": "^10.4.0",
    "prettier": "^3.6.2",
    "tailwindcss": "^4.0.0",
    "typescript": "^5.9.2",
    "vite": "^7.1.6",
    "vue-tsc": "^3.0.7",
    "zod": "^3.22.4"
  }
}
```

---

## ç»“è¯­

æœ¬æ–‡æ¡£ä¸º AI ä»£ç†æä¾›äº†å…¨é¢çš„é¡¹ç›®æŒ‡å—ã€‚åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼š

1. **éµå¾ªçº¦å®š**ï¼šä¿æŒé¡¹ç›®ç»“æ„å’Œå‘½åè§„èŒƒçš„ä¸€è‡´æ€§
2. **å®‰å…¨ç¬¬ä¸€**ï¼šå§‹ç»ˆéªŒè¯ IPC è¾“å…¥ï¼Œä½¿ç”¨ `contextIsolation`
3. **ç±»å‹å®‰å…¨**ï¼šå……åˆ†åˆ©ç”¨ TypeScriptï¼Œé¿å… `any`
4. **æ€§èƒ½è€ƒé‡**ï¼šé¿å…ä¸»è¿›ç¨‹é˜»å¡ï¼Œä¼˜åŒ– IPC é€šä¿¡
5. **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯æç¤ºå’ŒåŠ è½½çŠ¶æ€

**æœ€åæé†’**ï¼šæœ¬é¡¹ç›®çš„æ ¸å¿ƒå“²å­¦æ˜¯"æ¨¡æ¿é©±åŠ¨é…ç½®"ï¼Œæ‰€æœ‰åŠŸèƒ½è®¾è®¡éƒ½åº”å›´ç»•æ­¤åŸåˆ™ï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§å’Œç®€æ´æ€§ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0.0
**æœ€åæ›´æ–°**ï¼š2025-11-07
**ç»´æŠ¤è€…**ï¼šAI Agent + å¼€å‘å›¢é˜Ÿ


