# 报表生成器：交互设计规范

## 1. 核心概念

本文档定义了一个“报表生成器”工具。其核心是将“报表设计”与“报表运行”两个阶段彻底分离。

### 1.1 核心哲学：模板驱动配置 (Template-Driven Configuration)

本系统的**唯一“事实来源”是模板文件**。

- **创建/编辑时：** 系统**必须**首先解析模板中的所有 Carbone 标记（例如 `{{ d.name }}`、`{{ d.users[] }}`、`{{ v.report_month }}`）。
- **生成配置 UI：** 系统基于解析出的标记，**自动生成一个“待配置”清单**。
- **用户职责：** 用户的任务**不是“创建”配置项，而是“完成”**这个由系统生成的清单。

### 1.2 系统输入

1.  **模板文件 (Template)：** 业务所需的 `.xlsx` 报表模板（包含标记）。
2.  **数据源文件 (Data Source)：** 包含报表所需数据的 `.xlsx` 文件（一个或多个）。
3.  **运行时参数 (Runtime Parameter)：** 在“运行”报表时由用户临时输入的、非表格型的数据。

### 1.3 核心配置：报表契约 (Report Contract)

“报表契约”是本系统保存的“最小配置单元”。它是一个“配方”，定义了一份报表**如何**被生成。它包含：

1.  **模板：** 关联的 `.xlsx` 模板文件。
2.  **数据源绑定：** 模板中的*数据标记*（如 `{{d.name}}`）与数据源位置（如 `Sheet1!E5`）的映射关系。
3.  **参数定义：** 模板中的*参数标记*（如 `{{v.month}}`）与“运行时”输入（如“请输入月份”）的映射关系。

## 2. 宏观 UI 框架：报表中心 (Dashboard)

“报表中心”是用户打开应用时看到的**第一个界面**，也是所有工作流的起点。

| A 区：创建新报表   | B 区：已保存的报表契约                                                                                                                         |
| :----------------- | :--------------------------------------------------------------------------------------------------------------------------------------------- |
| `[ + 创建新报表 ]` | **每周销售报表** (契约 1) <br> _需要数据源：[销售数据], [员工数据]_ <br> _需要参数：[统计月份]_ <br> `[ 运行... ]` `[ 编辑 ]` `[ ... (更多) ]` |
|                    | **季度 KPI 汇总** (契约 2) <br> _需要数据源：[KPI 数据]_ <br> `[ 运行... ]` `[ 编辑 ]` `[ ... (更多) ]`                                        |

- `[ + 创建新报表 ]`：启动 **流程 2（创建新契约）**。
- `[ 运行... ]`：启动 **流程 1（运行报表）**。
- `[ 编辑 ]`：启动 **流程 3（编辑契约）**。

---

## 3. 流程 1：“运行”报表（高效复用）

这是用户最常使用的功能：使用已定义好的“契约”，配合新数据和新参数，来生成一份新报表。

1.  **动作：** 用户在“报表中心”点击 `[ 运行... ]`。
2.  **系统逻辑：** 系统加载该报表的“契约”，并检查其是否定义了“运行时参数”。
3.  **UI（弹出“运行时执行器”模态框）：**

### 场景 A：契约*不*包含“运行时参数”

- 系统只要求用户上传数据源文件。

<!-- end list -->

```markdown
**运行：季度 KPI 汇总**

_此报表需要 1 个数据源文件。请上传最新数据。_

---

**1. KPI 数据**
[ **上传“KPI 数据”文件** ] (或拖拽文件到此区域)

---

[ **生成报表** ] (上传后激活)
```

### 场景 B：契约*包含*“运行时参数”

- 系统会在顶部**动态渲染“参数输入”区域**。

<!-- end list -->

```markdown
**运行：每周销售报表**

_此报表需要 1 个参数和 2 个数据源。_

---

**1. 参数输入**

**请输入统计月份：**
[ **2025.11** ] (此为设计时设置的“默认值”)

---

**2. 数据源文件**

**[ 销售数据 ]**
[ **上传“销售数据”文件** ] (或拖拽)

**[ 员工数据 ]**
[ **上传“员工数据”文件** ] (或拖拽)

---

[ **生成报表** ] (上传所有文件后激活)
```

### 运行与结果

1.  **用户动作：**
    - （场景 B）用户将“统计月份”的值修改为 `2025.12`。
    - 用户上传所有必需的数据源文件。
    - 点击 `[ 生成报表 ]`。
2.  **系统执行：**
    - 系统打包**参数**（`report_month: "2025.12"`）和**数据源文件**，发送给报表引擎，严格按照“契约”进行渲染。
3.  **结果：** 模态框内显示生成的报表预览，并提供 `[ 下载报表 ]` 按钮。

---

## 4. 流程 2：“创建”新报表（设计契约）

这是“设计时”流程，用于创建全新的“报表契约”。

### 步骤 1：上传与解析模板

1.  **动作：** 用户点击 `[ + 创建新报表 ]`，进入 `[ 1. 上传模板 ]` 界面。
2.  **用户上传 `Template.xlsx`。**
3.  **系统核心逻辑（自动）：**
    - **(a) 解析标记：** 系统扫描模板，**自动提取所有** Carbone 标记。
    - **(b) 分类标记：**
      - `{{ d.company_name }}` -\> 归类为 [数据 - 单个值]
      - `{{ d.users[] }}` -\> 归类为 [数据 - 列表]
      - `{{ v.report_month }}` -\> 归类为 [运行时参数]
    - **(c) 生成清单：** 系统基于此分类，**自动生成**步骤 2 的“待配置清单”。
4.  **跳转：** 自动进入步骤 2。

### 步骤 2：配置契约（核心设计）

这是“模板驱动”的核心界面。它由两个**常驻**区域和一个**上下文**区域组成。

> **左侧区域：待配置清单 (系统生成)**
>
> - _模板中的所有标记都在这里，请逐项完成配置。_
>
> **数据标记 (d.)**
>
> - [ `d.company_name` ]
> - [ `d.users[]` ]
>
> **参数标记 (v.)**
>
> - [ `v.report_month` ]
>
> ---
>
> **右侧区域 (A)：数据源管理**
>
> - _声明此契约需要几个数据源。_
> - (•) **Source 1** (默认) [ 重命名 ]
> - [ **+ 添加数据源** ]
>
> ---
>
> **右侧区域 (B)：上下文配置面板**
>
> - _（请从左侧选择一个标记开始配置）_

---

#### 交互 2.1：配置“单个值”

1.  **动作：** 用户在“左侧清单”中点击 `[ d.company_name ]`。
2.  **UI：** “右侧区域 B”**动态加载**“单个值”的配置面板。

    ```markdown
    **配置：`d.company_name` (单个值)**

    1. **选择数据源：**
       [ **Source 1** ▼ ] (下拉框列出 A 区所有源)

    2. **选择工作表 (Sheet Name)：**
       [ ] (手动键入, 例如: Sheet1)

    3. **单元格坐标 (Cell Coordinate)：**
       [ ] (手动键入, 例如: E5)

    4. **(可选) 数据类型：**
       [ **自动检测** ▼ ] (选项: 自动, 文本, 数字, 日期)

    [ **保存此项配置** ]
    ```

3.  **完成：** 用户点击 `[ 保存此项配置 ]`。
    - **“左侧清单”更新：** `[ d.company_name ]` -\> `[Source 1]!Sheet1!E5`
    - **“右侧区域 B”** 恢复提示：“请选择下一个标记进行配置”。

#### 交互 2.2：配置“列表”

1.  **动作：** 用户在“左侧清单”中点击 `[ d.users[] ]`。
2.  **UI：** “右侧区域 B”**动态加载**“列表”的配置面板。

    ```markdown
    **配置：`d.users[]` (列表)**

    1. **选择数据源：** [ **Source 1** ▼ ]
    2. **选择工作表：** [ ] (手动键入, 例如: DataSheet)
    3. **指定数据范围方法：**
       (•) **从表头行开始** (推荐)
       ( ) **固定范围** (例如 `A2:C50`)
       ( ) **整列** (例如 `A:A`, `C:C`)

    ---

    _(根据选择，显示子面板)_
    **4. 定义绑定 (从表头行开始)**

    (a) **指定表头行号 (Header Row)：**
    [ ] (手动键入, 例如: 1)

    (b) **绑定字段与“列名（表头文本）”：**
    _模板 `d.users[]` 包含 `item.name`, `item.email` (自动解析)_

        | 模板字段 | 数据源中的“列名” (表头文本) |
        | :--- | :--- |
        | `item.name` | [     ] (手动键入, 例如: 姓名) |
        | `item.email`| [     ] (手动键入, 例如: 邮箱) |

    (c) **明确数据区域 (Data Start Row)：** 数据从第 [ ] 行开始读取。(手动键入, 例如: 2)

    [ **保存此项配置** ]
    ```

    _(注：系统必须自动解析 `d.users[]` 内部的 `item.` 标记，并自动生成 (b) 区的表格)_

#### 交互 2.3：配置“运行时参数”

1.  **动作：** 用户在“左侧清单”中点击 `[ v.report_month ]`。
2.  **UI：** “右侧区域 B”**动态加载**“运行时参数”的配置面板。

    ```markdown
    **配置：`v.report_month` (运行时参数)**

    1. **显示标签：**
       [ ] (手动键入, 例如: 请输入统计月份：)
       _(提示：在“运行”时显示给用户的友好名称)_

    2. **数据类型：**
       [ **文本** ▼ ] (选项: 文本, 数字, 日期)

    3. **默认值（可选）：**
       [ ] (手动键入, 例如: 2025.11)

    [ **保存此项配置** ]
    ```

3.  **完成：** `[ v.report_month ]` -\> `[参数：请输入统计月份：]`

### 步骤 3：测试与保存

1.  **激活：** 当“左侧清单”中**所有**标记都已配置（全部显示已保存的配置），`[ 3. 测试与保存 ]` 标签页**激活**。
2.  **动作：** 用户点击 `[ 3. 测试与保存 ]` 标签页。
3.  **UI（“测试”界面）：**
    - 系统**必须**模拟“运行（流程 1）”的场景。
    - 界面上会**同时渲染** C 区定义的 **(1) 参数输入框** 和 A 区定义的 **(2) 数据源上传框**。
4.  **用户动作：** 用户（设计者）在此界面填入测试参数并上传示例数据源文件，点击 `[ 运行测试 ]`。
5.  **结果（失败）：**
    - **精确报错**至关重要。
    - （例如）“契约失败：在 `[Source 1]` 的 `DataSheet` 工作表的 **第 1 行** 中，找不到表头“**姓名**”。请返回步骤 2 检查您的键入。”
6.  **结果（成功）：**
    - 系统在原地显示预览，证明所有手动键入的表达式均正确无误。
7.  **保存：**
    - 用户对测试结果满意后，点击 `[ 保存“报表契约” ]`。
    - 用户被带回到“报表中心 (Dashboard)”，在那里可以看到新创建的“报表契约”。

---

## 5. 流程 3：“编辑”报表契约

1.  **动作：** 用户在“报表中心”点击 `[ 编辑 ]`。
2.  **UI：** 系统加载“创建（流程 2）”的界面，并自动跳转到**步骤 2（配置契约）**。
3.  **状态（已填充）：**

    - **“左侧清单”** 已被系统**自动生成并填充**。

      > **数据标记 (d.)**

      > - [ `d.company_name` ] -\> `[Source 1]!Sheet1!E5`
      > - [ `d.users[]` ] -\> `[Source 1]!DataSheet!(R1:'姓名','邮箱'; R2)` > **参数标记 (v.)**
      > - [ `v.report_month` ] -\> `[参数：请输入统计月份：]`

    - **“右侧区域 A”** 已填充所有声明的数据源。

4.  **用户动作：**
    - 用户可以点击“左侧清单”中的任意一项（例如 `[ d.company_name ]`）。
    - “右侧区域 B”会**加载该项已保存的配置**（`Source 1`, `Sheet1`, `E5`）。
    - 用户**手动编辑**这些值（例如，将 `E5` 改为 `E6`），然后点击 `[ 更新此项配置 ]`。
5.  **保存：** 用户通过“步骤 3：测试与保存”来验证并覆盖旧的契约。
